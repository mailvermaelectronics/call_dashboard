<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ“ž Call Dashboard Pro+</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* --- BASE & GLOBAL STYLES --- */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter', sans-serif; background:#f0f4f3; transition:0.3s; color: #226d53;}

/* --- DARK MODE FIXES --- */
body.dark{background:#0f1a17; color:#e0e7e5;}
body.dark #sidebar, body.dark .card, body.dark table, body.dark #chartBox, body.dark .filterBtn, body.dark #dateFilter, body.dark .hidden-content {background:#152420; color:#e0e7e5;}
body.dark #modeBtn{background:#226d53; color:white;}
body.dark .menu-item:hover{background:#1c332d;}
body.dark .filterBtn{border-color:#2a453d;}
body.dark th,body.dark td{border-color:#226d5333;}
body.dark th{background:#1c332d; color:#e0e7e5;}
body.dark #dateFilter input{background:#1c332d; color:white; border-color:#2a453d;}
body.dark #search {background:#1c332d; color:white; border-color:#2a453d;}
body.dark .filterBtn.active{background: #226d53; color: white; border-color: #226d53;}

/* SIDEBAR */
#sidebar{
    width:260px;
    height:100vh;
    background:#ffffff;
    position:fixed;
    top:0; left:0;
    padding:25px;
    box-shadow:4px 0 25px rgba(34, 109, 83, 0.1);
    overflow:auto;
    transition:0.3s;
    z-index:1000;
}
.sidebar-logo {
    width: 100%;
    max-height: 80px;
    object-fit: contain;
    margin-bottom: 30px;
    display: block;
}
.menu-item{padding:14px; border-radius:12px; margin-bottom:10px; cursor:pointer; display:flex; align-items:center; gap:12px; font-size:15px; font-weight: 500; color: #226d53; transition: 0.2s;}
.menu-item i { color: #226d53; }
.menu-item:hover{background:#e9f1ee;}
.menu-item.active{background:#226d53; color:white;}
.menu-item.active i { color: white; }

/* MOBILE SIDEBAR */
@media(max-width:768px){
    #sidebar{position:relative; width:100%; height:auto; box-shadow:none;}
    #main{margin-left:0; padding:15px;}
} 
@media(min-width:769px){
    #main{margin-left:280px; padding:20px;}
}

/* TOPBAR */
#topbar{display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; margin-bottom:25px; gap:10px;}
#search{padding:12px 16px; width:280px; border-radius:10px; border:1px solid #226d5333; outline: none; color: #226d53;}
#search:focus { border-color: #226d53; }
#topbar > div { display: flex; gap: 10px; align-items: center;}

#modeBtn, #logoutBtn, #refreshBtn, #exportBtn{
    padding: 10px 18px; font-size: 14px; height: 42px; border: none;
    border-radius: 10px; cursor: pointer; font-weight: 600; display: inline-flex;
    align-items: center; gap: 8px; transition: 0.3s;
} 
#modeBtn{background:#226d53; color:white;}
#logoutBtn{background:#e63946; color:white;}
#refreshBtn{background:#38b48b; color:white;}
#exportBtn{background:#226d53; color:white;} 
#modeBtn:hover, #refreshBtn:hover, #exportBtn:hover { opacity: 0.9; transform: translateY(-2px); }

/* CARDS */
#cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:20px; margin-bottom:25px;}
.card{background:white; padding:25px; border-radius:20px; box-shadow:0 10px 30px rgba(34, 109, 83, 0.08); border: 1px solid #226d530d;}
.card h3{margin:0; font-size:14px; color: #226d53; opacity:0.8; text-transform: uppercase; letter-spacing: 0.5px;}
.card .value{font-size:32px; font-weight:800; margin-top:10px; color: #226d53;}

/* FILTERS ROW */
#filters-row{display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:15px; margin-bottom:25px;}
#filters{display:flex; flex-wrap:wrap; gap:10px;} 
#dateFilter{display:flex; align-items:center; gap:12px; background:white; padding:10px 20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.03); color: #226d53; font-weight: 500;}
#dateFilter input{padding:6px; border:1px solid #226d5333; border-radius:6px; width: 110px; text-align: center; color: #226d53; outline: none;}
#dateFilter input:focus { border-color: #226d53; }
.filterBtn{padding:10px 20px; border-radius:10px; border:1px solid #226d5333; cursor:pointer; background:white; color: #226d53; font-weight: 600; transition: 0.2s;}
.filterBtn.active{background:#226d53; color:white; border-color:#226d53;}

/* TABLE */
table{width:100%; border-collapse:collapse; background:white; border-radius:20px; overflow:hidden; margin-bottom:20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);}
th,td{padding:16px; border-bottom:1px solid #226d5314; text-align:center; color: #226d53;}
th{background:#f9fbfb; font-weight: 700; font-size: 14px;}

/* Pagination */
#pagination-controls {display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 25px;}
#pagination-controls button {padding: 10px 16px; border: 1px solid #226d5333; background: white; cursor: pointer; border-radius: 8px; color: #226d53; font-weight: 600;}
#pagination-controls button.active {background: #226d53; color: white; border-color: #226d53;}

/* CHARTS */
#charts-container {display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-top: 25px; justify-content: center;}
#chartBox{background:white; border-radius:24px; padding:30px; box-shadow:0 15px 40px rgba(34, 109, 83, 0.08); width: 100%; color: #226d53;}
#chartBox h3 { margin-bottom: 20px; font-weight: 700; }
#chartBox canvas{max-width:100% !important; height:auto !important;}

/* --- MODAL --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(15, 26, 23, 0.7); display: none; align-items: center;
    justify-content: center; z-index: 2000; backdrop-filter: blur(6px);
}
.modal-box {
    background: white; padding: 40px; border-radius: 24px; width: 90%;
    max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
body.dark .modal-box { background: #152420; color: white; }
.modal-box i { font-size: 60px; color: #e63946; margin-bottom: 20px; }
.modal-box h3 { font-size: 24px; margin-bottom: 12px; color: #226d53; }
body.dark .modal-box h3 { color: white; }
.modal-box p { color: #555; margin-bottom: 30px; line-height: 1.5; }
body.dark .modal-box p { color: #aaa; }
.modal-btns { display: flex; gap: 15px; justify-content: center; }
.modal-btns button {
    padding: 14px 25px; border-radius: 12px; border: none;
    font-weight: 700; cursor: pointer; font-size: 15px; flex: 1; transition: 0.2s;
}
.btn-cancel { background: #f0f4f3; color: #226d53; }
.btn-confirm { background: #e63946; color: white; }
.btn-confirm:hover { background: #c32f3a; }

@keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

</style>
</head>
<body>

<div id="logoutModal" class="modal-overlay">
    <div class="modal-box">
        <i class="fa-solid fa-right-from-bracket"></i>
        <h3>Logging Out?</h3>
        <p>Are you sure you want to end your current session? You will need to login again to access the dashboard.</p>
        <div class="modal-btns">
            <button class="btn-cancel" onclick="closeLogoutModal()">Keep Session</button>
            <button class="btn-confirm" onclick="confirmLogout()">Yes, Logout</button>
        </div>
    </div>
</div>

<div id="sidebar">
    <img src="https://drive.google.com/thumbnail?id=1scerhEsZRhAR_CrL31KIQZNx83Vzlfhc&sz=w1000" alt="Logo" class="sidebar-logo">
    <div class="menu-item" data-section="dashboard"><i class="fa fa-chart-line"></i> Dashboard</div>
    <div class="menu-item active" data-section="calls"><i class="fa fa-phone"></i> Call Logs</div>
    <div class="menu-item" data-section="profile"><i class="fa fa-user"></i> Profile</div>
    <div class="menu-item" data-section="settings"><i class="fa fa-gear"></i> Settings</div>
</div>

<div id="main">
    <div id="topbar">
        <input id="search" placeholder="Search number or name...">
        <div>
            <button id="exportBtn" style="display: none;"><i class="fa fa-download"></i> Export CSV</button> 
            <button id="refreshBtn"><i class="fa fa-sync-alt"></i> Refresh</button> 
            <button id="modeBtn">Dark Mode</button>
            <button id="logoutBtn">Logout</button>
        </div>
    </div>
    
    <div id="dashboard-content" class="section-content" style="display: none;">
        <div id="cards">
            <div class="card"><h3>Total Calls</h3><div class="value" id="totalCalls">0</div></div>
            <div class="card"><h3>Missed Calls</h3><div class="value" id="missedCalls">0</div></div>
            <div class="card"><h3>Today's Calls</h3><div class="value" id="todayCalls">0</div></div>
        </div>
        <div id="charts-container">
            <div id="chartBox"><h3>Call Type Distribution</h3><canvas id="chart"></canvas></div>
            <div id="chartBox"><h3>Monthly Calls</h3><canvas id="monthChart"></canvas></div>
        </div>
    </div>
    
    <div id="call-logs-content" class="section-content"> 
         <div id="filters-row">
            <div id="filters">
                <button class="filterBtn active" data-type="all">All Logs</button>
                <button class="filterBtn" data-type="incoming">Incoming</button>
                <button class="filterBtn" data-type="outgoing">Outgoing</button>
                <button class="filterBtn" data-type="missed">Missed</button>
            </div>
            <div id="dateFilter">
                <i class="fa fa-calendar-alt"></i>
                <span>From:</span>
                <input type="text" id="startDate" placeholder="DD/MM/YYYY" maxlength="10" oninput="autoFormatDate(this)">
                <span>To:</span>
                <input type="text" id="endDate" placeholder="DD/MM/YYYY" maxlength="10" oninput="autoFormatDate(this)">
            </div>
        </div>
        <table>
            <thead><tr><th>Number</th><th>Name</th><th>Type</th><th>Duration</th><th>Date</th></tr></thead>
            <tbody id="tbody"></tbody>
        </table>
        <div id="pagination-controls"></div>
    </div>

    <div id="dynamic-content" class="hidden-content" style="display: none; text-align:center; padding:50px; background: white; border-radius: 20px;">
        Loading content...
    </div>
</div>

<script>
// LOGIN PROTECTION
if(sessionStorage.getItem("auth")!=="1"){ window.location.href="index.html"; }

let allData = [];
let filteredData = []; 
let chart, monthlyChart;
let currentPage = 1;
const rowsPerPage = 10;
const exportBtn = document.getElementById('exportBtn');

// --- PROFESSIONAL LOGOUT FUNCTIONS ---
document.getElementById("logoutBtn").onclick = () => {
    document.getElementById("logoutModal").style.display = "flex";
};
function closeLogoutModal() {
    document.getElementById("logoutModal").style.display = "none";
}
function confirmLogout() {
    sessionStorage.removeItem("auth");
    window.location.href = "index.html";
}
window.onclick = function(event) {
    let modal = document.getElementById("logoutModal");
    if (event.target == modal) closeLogoutModal();
}

function autoFormatDate(input) {
    let value = input.value.replace(/[^0-9]/g, ''); 
    if (value.length > 2) value = value.substring(0, 2) + '/' + value.substring(2);
    if (value.length > 4) value = value.substring(0, 5) + '/' + value.substring(5);
    input.value = value.substring(0, 10);
    if (input.value.length === 10) { currentPage = 1; applyFilters(); }
}

function parseDateForFilter(dateString) {
    if (!dateString) return null;
    const parts = dateString.trim().split('/');
    if (parts.length === 3) return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
    return null; 
}

function formatDateForTable(isoDate) {
    if (!isoDate) return '';
    const datePart = isoDate.split('T')[0];
    const parts = datePart.split('-');
    return parts.length === 3 ? `${parts[2]}/${parts[1]}/${parts[0]}` : datePart;
}

async function loadData(){
    try{
        let res=await fetch("data.json?cache="+Math.random()); 
        allData = await res.json();
    }catch(e){ allData = []; }
    applyFilters();
}
loadData();
setInterval(loadData,8000); 

document.getElementById("modeBtn").onclick=()=>{
    document.body.classList.toggle("dark");
    document.getElementById("modeBtn").innerText = document.body.classList.contains("dark")?"Light Mode":"Dark Mode";
};

document.getElementById("refreshBtn").onclick=()=>{ currentPage = 1; loadData(); };

document.querySelectorAll(".menu-item").forEach(item => {
    item.onclick = () => {
        document.querySelectorAll(".menu-item").forEach(i => i.classList.remove("active"));
        item.classList.add("active");
        const section = item.dataset.section;
        document.getElementById('dashboard-content').style.display = section === 'dashboard' ? 'block' : 'none';
        document.getElementById('call-logs-content').style.display = section === 'calls' ? 'block' : 'none';
        document.getElementById('dynamic-content').style.display = (section !== 'dashboard' && section !== 'calls') ? 'block' : 'none';
        exportBtn.style.display = section === 'calls' ? 'inline-flex' : 'none';
        if (section !== 'dashboard' && section !== 'calls') {
            document.getElementById('dynamic-content').innerHTML = `<h2 style='color:#226d53'>${section.toUpperCase()}</h2><p style='margin-top:20px; color:#555'>This section is coming soon with more professional features.</p>`;
        }
        applyFilters(); 
    };
});

function applyFilters() {
    let temp = allData;
    const activeType = document.querySelector('#filters .filterBtn.active');
    const type = activeType ? activeType.dataset.type : 'all';
    if (type !== 'all') temp = temp.filter(x => x.type === type);
    
    const filterStartDate = parseDateForFilter(document.getElementById('startDate').value);
    const filterEndDate = parseDateForFilter(document.getElementById('endDate').value);
    
    if (filterStartDate || filterEndDate) {
        temp = temp.filter(x => {
            const dataDate = x.date.split('T')[0];
            if (filterStartDate && filterEndDate) return dataDate >= filterStartDate && dataDate <= filterEndDate;
            return filterStartDate ? dataDate >= filterStartDate : dataDate <= filterEndDate;
        });
    }
    
    const q = document.getElementById("search").value.toLowerCase();
    filteredData = temp.filter(x => x.number.toLowerCase().includes(q) || x.name.toLowerCase().includes(q));

    updateStats(filteredData); 
    if(document.getElementById('dashboard-content').style.display !== 'none') {
        updateChart(filteredData); 
        updateMonthlyChart(filteredData);
    }
    changePage(currentPage);
}

document.querySelectorAll(".filterBtn").forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll(".filterBtn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentPage = 1; applyFilters();
    };
});

document.getElementById('search').onkeyup = () => { currentPage = 1; applyFilters(); };

function changePage(page) {
    const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
    if (page < 1) page = 1;
    if (page > totalPages) page = totalPages;
    currentPage = page;
    const data = filteredData.slice().reverse(); 
    const start = (page - 1) * rowsPerPage;
    updateTable(data.slice(start, start + rowsPerPage)); 
    renderPagination(data.length, currentPage);
}

function updateTable(data){
    let tb=document.getElementById("tbody");
    tb.innerHTML= data.length === 0 ? '<tr><td colspan="5">No calls found.</td></tr>' : "";
    data.forEach(c=>{
        tb.innerHTML+=`<tr><td>${c.number}</td><td>${c.name}</td><td>${c.type}</td><td>${c.duration}</td><td>${formatDateForTable(c.date)}</td></tr>`;
    });
}

function renderPagination(totalRows, currentPage) {
    const paginationEl = document.getElementById("pagination-controls");
    paginationEl.innerHTML = '';
    const pageCount = Math.ceil(totalRows / rowsPerPage);
    if (pageCount <= 1) return; 
    const prevBtn = document.createElement('button');
    prevBtn.innerHTML = '<i class="fa fa-chevron-left"></i>';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => changePage(currentPage - 1);
    paginationEl.appendChild(prevBtn);
    for (let i = 1; i <= pageCount; i++) {
        if(pageCount > 5 && i > 3 && i < pageCount) { if(i==4) paginationEl.innerHTML += "<span style='color:#226d53'>...</span>"; continue; }
        const btn = document.createElement('button');
        btn.innerText = i;
        if (i === currentPage) btn.classList.add('active');
        btn.onclick = () => changePage(i);
        paginationEl.appendChild(btn);
    }
    const nextBtn = document.createElement('button');
    nextBtn.innerHTML = '<i class="fa fa-chevron-right"></i>';
    nextBtn.disabled = currentPage === pageCount;
    nextBtn.onclick = () => changePage(currentPage + 1);
    paginationEl.appendChild(nextBtn);
}

function updateChart(data){
    let incoming=data.filter(x=>x.type==="incoming").length;
    let outgoing=data.filter(x=>x.type==="outgoing").length;
    let missed=data.filter(x=>x.type==="missed").length;
    const chartBox = document.querySelector('#charts-container > #chartBox:first-child'); 
    if (!chartBox) return;
    let oldCanvas = document.getElementById('chart');
    if (oldCanvas) { if(chart) chart.destroy(); oldCanvas.remove(); }
    const newCanvas = document.createElement('canvas');
    newCanvas.id = 'chart'; chartBox.querySelector('h3').after(newCanvas); 
    chart = new Chart(newCanvas, { 
        type:"doughnut",
        data:{labels:["Incoming","Outgoing","Missed"],datasets:[{data:[incoming,outgoing,missed],backgroundColor:["#38b48b","#226d53","#e63946"], borderJoinStyle: 'round'}]},
        options:{ responsive:true, plugins:{legend:{position:"bottom", labels: { color: '#226d53', font: { weight: '600' } } } }, animation: { duration: 1500, easing: 'easeOutBounce' } }
    });
}

function updateMonthlyChart(data){
    let months={};
    data.forEach(x=>{let m=x.date.slice(0,7); months[m]=(months[m]||0)+1;}); 
    let labels=Object.keys(months).sort();
    let values=labels.map(k=>months[k]);
    const chartBox = document.querySelector('#charts-container > #chartBox:last-child');
    if (!chartBox) return;
    let oldCanvas = document.getElementById('monthChart');
    if (oldCanvas) { if(monthlyChart) monthlyChart.destroy(); oldCanvas.remove(); }
    const newCanvas = document.createElement('canvas');
    newCanvas.id = 'monthChart'; chartBox.appendChild(newCanvas);
    monthlyChart=new Chart(newCanvas,{
        type:"bar",
        data:{labels,datasets:[{label:"Calls",data:values,backgroundColor:"#226d53", borderRadius: 8}]},
        options:{ responsive:true, plugins:{legend:{display:false}}, scales: { x: { ticks: { color: '#226d53' } }, y: { ticks: { color: '#226d53' } } }, animation: { duration: 1200 } }
    });
}

function updateStats(d){
    document.getElementById("totalCalls").innerText=d.length;
    document.getElementById("missedCalls").innerText=d.filter(x=>x.type==="missed").length;
    let today=new Date().toISOString().slice(0,10);
    document.getElementById("todayCalls").innerText=d.filter(x=>x.date.includes(today)).length;
}

document.getElementById("exportBtn").onclick = () => {
    const data = filteredData; 
    if (data.length === 0) return alert("No data to export.");
    let csv = "Number,Name,Type,Duration,Date\n" + data.map(item => `"${item.number}","${item.name}","${item.type}","${item.duration}","${formatDateForTable(item.date)}"`).join("\n");
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "call_logs.csv"; a.click();
};

document.addEventListener('DOMContentLoaded', () => {
    document.querySelector('.menu-item[data-section="calls"]').click(); 
});
</script>
</body>
</html>
