<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Call Dashboard Pro+ v12 (Final Fixes)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* --- BASE & GLOBAL STYLES --- */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Inter,sans-serif;background:#f4f4f8;transition:0.3s;}

/* --- DARK MODE FIXES --- */
body.dark{background:#111;color:#fff;}
body.dark #sidebar, body.dark .card, body.dark table, body.dark #chartBox, body.dark .filterBtn, body.dark #dateFilter, body.dark .hidden-content {background:#1b1b1b; color:#fff;}
body.dark #modeBtn{background:white;color:black;}
body.dark .menu-item:hover{background:#222;}
body.dark .filterBtn{border-color:#444;}
body.dark th,body.dark td{border-color:#333;}
body.dark th{background:#222;}
body.dark #dateFilter input{background:#333;color:white;border-color:#555;}
body.dark #search {background:#1f1f1f; color:white; border-color:#555;}

/* SIDEBAR */
#sidebar{
    width:260px;
    height:100vh;
    background:#fff;
    position:fixed;
    top:0; left:0;
    padding:25px;
    box-shadow:4px 0 20px rgba(0,0,0,0.08);
    overflow:auto;
    transition:0.3s;
    z-index:1000;
}
#sidebar h2{margin-bottom:25px;font-size:22px;font-weight:700;}
.menu-item{padding:12px;border-radius:10px;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;gap:12px;font-size:15px;}
.menu-item:hover{background:#efefef;}
.menu-item.active{background:#2196F3;color:white;}

/* MOBILE SIDEBAR */
@media(max-width:768px){
    #sidebar{position:relative;width:100%;height:auto;box-shadow:none;}
    #main{margin-left:0;padding:15px;}
} 
@media(min-width:769px){
    #main{margin-left:280px;padding:20px;}
}

/* TOPBAR */
#topbar{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:20px;gap:10px;}
#search{padding:10px 14px;width:250px;border-radius:8px;border:1px solid #ccc;}
#topbar > div { 
    display: flex;
    gap: 10px; 
    align-items: center;
}
/* BUTTON STYLE FIX (Export button added) */
#modeBtn, #logoutBtn, #refreshBtn, #exportBtn{
    padding: 10px 16px;
    font-size: 14px; 
    height: 40px; 
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: 0.2s;
} 
#modeBtn{background:black;color:white;}
#logoutBtn{background:#e63946;color:white;}
#refreshBtn{background:#ff9800;color:white;}
#exportBtn{background:#00bcd4;color:white;} 

/* CARDS */
#cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px;}
.card{background:white;padding:20px;border-radius:16px;box-shadow:0 5px 20px rgba(0,0,0,0.1);}
.card h3{margin:0;font-size:15px;opacity:0.8;}
.card .value{font-size:28px;font-weight:700;margin-top:8px;text-align:center;}

/* FILTERS ROW (Combined Type and Date) */
#filters-row{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:15px;margin-bottom:20px;}
#filters{display:flex;flex-wrap:wrap;gap:10px;} 
#dateFilter{
    display:flex; 
    align-items:center; 
    gap:10px; 
    background:white; 
    padding:8px 15px;
    border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,0.05);
}
#dateFilter input{padding:5px;border:1px solid #ccc;border-radius:5px;}

.filterBtn{padding:10px 16px;border-radius:8px;border:1px solid #bbb;cursor:pointer;background:white;}
.filterBtn.active{background:black;color:white;border-color:black;}

/* TABLE */
table{width:100%;border-collapse:collapse;background:white;border-radius:16px;overflow:hidden;margin-bottom:15px;}
th,td{padding:12px;border-bottom:1px solid #eee;text-align:center;}
th{background:#fafafa;}

/* Pagination Styles */
#pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    user-select: none;
}
#pagination-controls button {
    padding: 8px 12px;
    border: 1px solid #ccc;
    background: white;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.2s;
}
#pagination-controls button:hover:not(.active) {
    background: #f0f0f0;
}
#pagination-controls button.active {
    background: #2196F3;
    color: white;
    border-color: #2196F3;
    cursor: default;
}
#pagination-controls button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

@media(max-width:600px){
    /* Table fixes for mobile */
    table,thead,tbody,th,td,tr{display:block;}
    th{display:none;}
    td{padding:10px;position:relative;border:none;border-bottom:1px solid #444;}
    td:before{position:absolute;top:10px;left:10px;width:120px;font-weight:600;color:#888;white-space:nowrap;}
    td:nth-of-type(1):before{content:"Number";}
    td:nth-of-type(2):before{content:"Name";}
    td:nth-of-type(3):before{content:"Type";}
    td:nth-of-type(4):before{content:"Duration";}
    td:nth-of-type(5):before{content:"Date";}
    
    /* Date Filter in one row (Fixed CSS) */
    #dateFilter { 
        display: flex; 
        flex-wrap: wrap; 
        align-items: center;
        gap: 5px; 
        padding: 8px;
    }
    #dateFilter input {
        max-width: 100px; 
    }
}

/* CHART ALIGNMENT FIX */
#charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
    gap: 20px;
    margin-top: 20px;
    justify-content: center;
}

#chartBox{
    background:white;
    border-radius:20px;
    padding:25px;
    box-shadow:0 5px 25px rgba(0,0,0,0.1);
    width: 100%;
}
#chartBox canvas{max-width:100% !important;height:auto !important;}

/* Dynamic Content Style */
.hidden-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.1);
    min-height: 400px;
    text-align: center;
    font-size: 20px;
    font-weight: 600;
}
</style>
</head>
<body>

<div id="sidebar">
    <h2>üìû Dashboard Pro+</h2>
    <div class="menu-item active" data-section="dashboard"><i class="fa fa-chart-line"></i> Dashboard</div>
    <div class="menu-item" data-section="calls"><i class="fa fa-phone"></i> Call Logs</div>
    <div class="menu-item" data-section="profile"><i class="fa fa-user"></i> Profile</div>
    <div class="menu-item" data-section="settings"><i class="fa fa-gear"></i> Settings</div>
</div>

<div id="main">
    <div id="topbar">
        <input id="search" placeholder="Search number or name...">
        <div>
            <button id="exportBtn" style="display: none;"><i class="fa fa-download"></i> Export CSV</button> 
            <button id="refreshBtn"><i class="fa fa-sync-alt"></i> Refresh</button> 
            <button id="modeBtn">Dark Mode</button>
            <button id="logoutBtn">Logout</button>
        </div>
    </div>
    
    <div id="dashboard-content" class="section-content" style="display: none;">
        <div id="cards">
            <div class="card"><h3>Total Calls</h3><div class="value" id="totalCalls">0</div></div>
            <div class="card"><h3>Missed Calls</h3><div class="value" id="missedCalls">0</div></div>
            <div class="card"><h3>Today's Calls</h3><div class="value" id="todayCalls">0</div></div>
        </div>
        
        <div id="charts-container">
            <div id="chartBox">
                <h3>Call Type Distribution</h3>
                <canvas id="chart"></canvas> 
            </div>

            <div id="chartBox">
                <h3>Monthly Calls</h3>
                <canvas id="monthChart"></canvas>
            </div>
        </div>
    </div>
    
    <div id="call-logs-content" class="section-content" style="display: none;">
         <div id="filters-row">
            <div id="filters">
                <button class="filterBtn active" data-type="all">All</button>
                <button class="filterBtn" data-type="incoming">Incoming</button>
                <button class="filterBtn" data-type="outgoing">Outgoing</button>
                <button class="filterBtn" data-type="missed">Missed</button>
            </div>
            <div id="dateFilter">
                <label for="startDate">Date From:</label>
                <input type="date" id="startDate">
                <label for="endDate">To:</label>
                <input type="date" id="endDate">
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Number</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Duration</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
        
        <div id="pagination-controls">
            </div>

    </div>

    <div id="dynamic-content" class="hidden-content" style="display: none;">
        Loading content...
    </div>

</div>

<script>
// LOGIN PROTECTION
if(sessionStorage.getItem("auth")!=="1"){ window.location.href="index.html"; }

// --- GLOBAL VARIABLES ---
let allData = [];
let filteredData = []; 
let chart, monthlyChart;

// Pagination Variables
let currentPage = 1;
const rowsPerPage = 10;

const exportBtn = document.getElementById('exportBtn');


// --- CORE DATA LOADING ---
async function loadData(){
    try{
        let res=await fetch("data.json?cache="+Math.random()); 
        if(!res.ok) {
            throw new Error(`Data Load Error: Status ${res.status}`);
        }
        allData = await res.json();
        console.log("data.json loaded successfully.");
    }catch(e){ 
        allData = []; 
        console.error("Error loading data.json. Call logs will be empty.", e);
    }
    
    applyFilters();
}
loadData();
// Keeping your original auto-refresh interval
setInterval(loadData,8000); 

// --- LOGOUT & DARK MODE ---
document.getElementById("logoutBtn").onclick=()=>{
    if(confirm("Are you sure you want to log out?")){
        sessionStorage.removeItem("auth");
        window.location.href="index.html";
    }
};

document.getElementById("modeBtn").onclick=()=>{
    document.body.classList.toggle("dark");
    document.getElementById("modeBtn").innerText = document.body.classList.contains("dark")?"Light Mode":"Dark Mode";
};

// Reset page to 1 on manual refresh (Refresh button calls loadData which forces animation)
document.getElementById("refreshBtn").onclick=()=>{
    currentPage = 1; 
    loadData();
};


// --- STRUCTURAL & MENU LOGIC FIX (DASHBOARD CLICK FIX APPLIED HERE) ---
document.querySelectorAll(".menu-item").forEach(item => {
    item.onclick = () => {
        document.querySelectorAll(".menu-item").forEach(i => i.classList.remove("active"));
        item.classList.add("active");
        
        const section = item.dataset.section;
        const dashboardContent = document.getElementById('dashboard-content');
        const callLogsContent = document.getElementById('call-logs-content');
        const dynamicContent = document.getElementById('dynamic-content');

        // Reset display states and export button
        dashboardContent.style.display = 'none';
        callLogsContent.style.display = 'none';
        dynamicContent.style.display = 'none';
        exportBtn.style.display = 'none'; 
        
        // Show relevant section
        if (section === 'dashboard') {
            dashboardContent.style.display = 'block';
            // **FIX for Nachna**: Directly call chart updates with current data to force animation 
            // This runs even if the dashboard is already active.
            if(filteredData.length > 0) { // Safety check
                updateChart(filteredData);
                updateMonthlyChart(filteredData);
            }
        } else if (section === 'calls') {
            callLogsContent.style.display = 'block';
            exportBtn.style.display = 'inline-flex'; 
        } else { // profile/settings
            dynamicContent.style.display = 'block';
            dynamicContent.innerHTML = `
                <h2>${section.toUpperCase()}</h2>
                <p>Welcome to the ${section} section. This area is **under active development** and features will be available soon!</p>
            `;
        }
        
        applyFilters(); 
    };
});


// --- CALL LOGS & FILTERING LOGIC ---
function applyFilters() {
    let temp = allData;

    // 1. Apply Type Filter
    const activeType = document.querySelector('#filters .filterBtn.active');
    const type = activeType ? activeType.dataset.type : 'all';
    if (type !== 'all') {
        temp = temp.filter(x => x.type === type);
    }
    
    // 2. Apply Date Filter
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (startDate || endDate) {
        temp = temp.filter(x => {
            const dataDate = x.date.split('T')[0]; 
            
            if (startDate && endDate) {
                return dataDate >= startDate && dataDate <= endDate;
            } else if (startDate) {
                return dataDate >= startDate;
            } else if (endDate) {
                return dataDate <= endDate;
            }
            return true; 
        });
    }
    
    // 3. Apply Search Filter
    const q = document.getElementById("search").value.toLowerCase();
    filteredData = temp.filter(x => x.number.toLowerCase().includes(q) || x.name.toLowerCase().includes(q));

    // Update UI components with the final filtered/searched data
    updateStats(filteredData); 
    updateChart(filteredData); // Chart updates here
    updateMonthlyChart(filteredData);
    
    changePage(currentPage);
}

// Attach event listeners for filtering (Reset page to 1 on filter/search change)
document.querySelectorAll(".filterBtn").forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll(".filterBtn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentPage = 1; 
        applyFilters();
    };
});

document.getElementById('startDate').onchange = () => { currentPage = 1; applyFilters(); };
document.getElementById('endDate').onchange = () => { currentPage = 1; applyFilters(); };
document.getElementById('search').onkeyup = () => { currentPage = 1; applyFilters(); };


// --- PAGINATION & TABLE LOGIC ---

function changePage(page) {
    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
    if (page < 1) page = 1;
    if (page > totalPages) page = totalPages;

    currentPage = page;
    const data = filteredData.slice().reverse(); 

    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    
    const paginatedItems = data.slice(start, end); 

    updateTable(paginatedItems); 
    renderPagination(data.length, currentPage);
}

function updateTable(data){
    let tb=document.getElementById("tbody");
    tb.innerHTML="";
     if (data.length === 0) {
        tb.innerHTML = '<tr><td colspan="5">No calls found. Please ensure data.json is present or adjust filters.</td></tr>';
        return;
    }
    data.forEach(c=>{
        tb.innerHTML+=`<tr>
            <td>${c.number}</td>
            <td>${c.name}</td>
            <td>${c.type}</td>
            <td>${c.duration}</td>
            <td>${c.date.split('T')[0]}</td>
        </tr>`;
    });
}

function renderPagination(totalRows, currentPage) {
    const paginationEl = document.getElementById("pagination-controls");
    paginationEl.innerHTML = '';
    
    const pageCount = Math.ceil(totalRows / rowsPerPage);

    if (pageCount <= 1) return; 

    // Previous Button
    const prevBtn = document.createElement('button');
    prevBtn.innerHTML = '<i class="fa fa-angle-left"></i> Previous';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => changePage(currentPage - 1);
    paginationEl.appendChild(prevBtn);

    // Page Number Buttons
    const maxButtons = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
    let endPage = Math.min(pageCount, startPage + maxButtons - 1);

    if (endPage - startPage + 1 < maxButtons) {
        startPage = Math.max(1, endPage - maxButtons + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        btn.classList.add('page-num');
        if (i === currentPage) {
            btn.classList.add('active');
        }
        btn.onclick = () => changePage(i);
        paginationEl.appendChild(btn);
    }
    
    // Next Button
    const nextBtn = document.createElement('button');
    nextBtn.innerHTML = 'Next <i class="fa fa-angle-right"></i>';
    nextBtn.disabled = currentPage === pageCount;
    nextBtn.onclick = () => changePage(currentPage + 1);
    paginationEl.appendChild(nextBtn);
}

// --- CHART FUNCTIONS (PERMANENT ANIMATION FIX AND SYNTAX ERROR FIX) ---
function updateChart(data){
    let incoming=data.filter(x=>x.type==="incoming").length;
    let outgoing=data.filter(x=>x.type==="outgoing").length;
    let missed=data.filter(x=>x.type==="missed").length;
    
    // Chart Container ‡§ú‡§π‡§æ‡§Å Doughnut Chart ‡§∞‡§π‡§§‡§æ ‡§π‡•à (‡§™‡§π‡§≤‡§æ #chartBox)
    const chartBox = document.querySelector('#charts-container > #chartBox:first-child'); 
    
    // FIX 1: Safety check to prevent crashing if the element is not found
    if (!chartBox) return;
    
    // 2. ‡§™‡•Å‡§∞‡§æ‡§®‡•á Canvas ‡§ï‡•ã DOM ‡§∏‡•á ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
    let oldCanvas = document.getElementById('chart');
    if (oldCanvas) {
        // 1. ‡§Ö‡§ó‡§∞ ‡§™‡•Å‡§∞‡§æ‡§®‡§æ Chart Object ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à, ‡§§‡•ã ‡§â‡§∏‡•á ‡§®‡§∑‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç (Destroy before removing element)
        if(chart) {
            chart.destroy();
            chart = null; 
        }
        oldCanvas.remove();
    }
    
    // 3. ‡§è‡§ï ‡§®‡§Ø‡§æ Canvas Element ‡§¨‡§®‡§æ‡§è‡§Å
    const newCanvas = document.createElement('canvas');
    newCanvas.id = 'chart'; // ID ‡§µ‡§π‡•Ä ‡§∞‡§ñ‡•á‡§Ç
    
    // 4. ‡§®‡§è Canvas ‡§ï‡•ã ChartBox ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (H3 ‡§ï‡•á ‡§¨‡§æ‡§¶)
    const h3 = chartBox.querySelector('h3');
    if (h3) {
        h3.after(newCanvas); // H3 ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
    } else {
        chartBox.appendChild(newCanvas);
    }
    
    // 5. ‡§®‡§è Canvas ‡§™‡§∞ Chart ‡§¨‡§®‡§æ‡§è‡§Å (SYNTAX ERROR FIXED)
    chart = new Chart(newCanvas, { 
        type:"doughnut",
        // datasets ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§ï‡•Ä ‡§ó‡§≤‡§§‡•Ä (extra '()') ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à
        data:{labels:["Incoming","Outgoing","Missed"],datasets:[{data:[incoming,outgoing,missed],backgroundColor:["#4CAF50","#2196F3","#e63946"]}]},
        options:{
            responsive:true, 
            maintainAspectRatio: true, 
            aspectRatio: 1, 
            plugins:{legend:{position:"bottom"}},
            animation: { // <--- ‡§Ø‡§π ‡§π‡•à ‡§µ‡§π Animation ‡§ú‡•ã ‡§á‡§∏‡•á ‡§®‡§ö‡§æ‡§§‡§æ ‡§π‡•à
                duration: 1000, 
                easing: 'easeOutQuart'
            }
        }
    });
}

function updateMonthlyChart(data){
    let months={};
    data.forEach(x=>{let m=x.date.slice(0,7); months[m]=(months[m]||0)+1;});
    let labels=Object.keys(months).sort();
    let values=labels.map(k=>months[k]);
    if(monthlyChart) monthlyChart.destroy();
    monthlyChart=new Chart(document.getElementById("monthChart"),{
        type:"bar",
        data:{labels,datasets:[{label:"Monthly Calls",data:values,backgroundColor:"#2196F3"}]},
        options:{
            responsive:true, 
            maintainAspectRatio: true, 
            aspectRatio: 1, 
            plugins:{legend:{display:false}},
            animation: { // <--- ‡§Ø‡§π ‡§≠‡•Ä ‡§è‡§®‡§ø‡§Æ‡•á‡§ü ‡§π‡•ã‡§ó‡§æ
                duration: 800, 
                easing: 'easeOutQuart'
            }
        }
    });
}

// --- OTHER UTILITY FUNCTIONS ---
function updateStats(d){
    document.getElementById("totalCalls").innerText=d.length;
    document.getElementById("missedCalls").innerText=d.filter(x=>x.type==="missed").length;
    let today=new Date().toISOString().slice(0,10);
    document.getElementById("todayCalls").innerText=d.filter(x=>x.date.includes(today)).length;
}

// --- EXPORT TO CSV FUNCTION ---
document.getElementById("exportBtn").onclick = () => {
    const data = filteredData; 
    if (data.length === 0) {
        alert("No data to export.");
        return;
    }

    const headers = ["Number", "Name", "Type", "Duration", "Date"];
    const rows = [headers.join(',')];

    data.forEach(item => {
        const row = [
            item.number,
            item.name,
            item.type,
            item.duration,
            item.date.split('T')[0] 
        ].map(d => `"${d}"`).join(','); 

        rows.push(row);
    });

    const csvContent = rows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    if (link.download !== undefined) { 
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "call_logs_export_" + new Date().toISOString().slice(0, 10) + ".csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } else {
        alert("Your browser does not support CSV download.");
    }
};


// LIVE WEBHOOK (Retained for real-time updates)
try{
    const stream=new EventSource("https://your-proxy-endpoint/webhook");
    stream.onmessage=e=>pushWebhook(JSON.parse(e.data));
}catch(err){console.log("Webhook unavailable",err);}
async function pushWebhook(data){
    allData.push(data);
    applyFilters(); 
}

// Initial setup to display Dashboard on load
document.addEventListener('DOMContentLoaded', () => {
    document.querySelector('.menu-item[data-section="dashboard"]').click();
});
</script>
</body>
</html>
